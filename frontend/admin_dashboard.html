<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-100">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <div class="bg-indigo-800 text-white w-64 py-6 flex flex-col">
      <div class="px-6 mb-8">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
      </div>
      <nav class="flex-1">
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="dashboard">
          <i class="fas fa-home w-6"></i>
          <span>Dashboard</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="register">
          <i class="fas fa-user-plus w-6"></i>
          <span>Register Student</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="view-all">
          <i class="fas fa-users w-6"></i>
          <span>View All Students</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="create-admin">
          <i class="fas fa-user-shield w-6"></i>
          <span>Create Admin</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="search">
          <i class="fas fa-search w-6"></i>
          <span>Search Students</span>
        </a>
      </nav>
      <div class="px-6 pt-6">
        <button id="logoutBtn" class="w-full flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md transition-colors">
          <i class="fas fa-sign-out-alt w-6"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
      <!-- Top Bar -->
      <div class="bg-white shadow p-4 flex justify-between items-center">
        <h2 id="pageTitle" class="text-2xl font-semibold">Dashboard</h2>
        <div id="adminInfo" class="flex items-center">
          <span id="adminEmail" class="mr-2"></span>
          <i class="fas fa-user-circle text-2xl"></i>
        </div>
      </div>

      <!-- Dynamic Content -->
      <div id="mainContent" class="p-6 flex-1">
        <!-- Content loads here -->
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Edit Student</h3>
        <button id="closeEditModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editStudentForm" class="space-y-4">
        <input type="hidden" id="editStudentMatric">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Matric (readonly)</label>
            <input type="text" id="editMatric" class="w-full p-2 border rounded bg-gray-100" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium">First Name</label>
            <input type="text" id="editFirstname" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Last Name</label>
            <input type="text" id="editLastname" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Gender</label>
            <select id="editGender" class="w-full p-2 border rounded" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Course</label>
            <select id="editCourse" class="w-full p-2 border rounded" required>
              <option value="BSIT">BS Information Technology</option>
              <option value="BSCS">BS Computer Science</option>
              <option value="BSIS">BS Information Systems</option>
              <option value="BSCE">BS Computer Engineering</option>
              <option value="BSECE">BS Electronics Engineering</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Year Level</label>
            <select id="editLevel" class="w-full p-2 border rounded" required>
              <option value="1">First Year</option>
              <option value="2">Second Year</option>
              <option value="3">Third Year</option>
              <option value="4">Fourth Year</option>
              <option value="5">Fifth Year</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Section</label>
            <input type="text" id="editSection" class="w-full p-2 border rounded" required>
          </div>
        </div>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Changes</button>
        </div>
      </form>
      <div id="editStatusMessages" class="mt-4 hidden"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <div class="text-center">
        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-bold mb-2">Confirm Delete</h3>
        <p id="confirmMessage" class="mb-6">Are you sure you want to delete this student?</p>
        <div class="flex justify-center space-x-4">
          <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*====================================
      Authentication & AJAX Setup
    ====================================*/
    function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/admin/login';
        return false;
      }
      return true;
    }

    function setupAjax() {
      $.ajaxSetup({
        beforeSend: function(xhr) {
          const token = localStorage.getItem('adminToken');
          if (token) {
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
          }
        },
        error: function(xhr) {
          if (xhr.status === 401 || xhr.status === 403) {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
          }
        }
      });
    }

    async function verifySession() {
      try {
        const response = await $.ajax({
          url: '/api/v1/admin/me',
          method: 'GET'
        });
        $('#adminEmail').text(response.email);
        return true;
      } catch (error) {
        console.error("Session verification failed:", error);
        return false;
      }
    }

    /*====================================
         Page Navigation & Loader
    ====================================*/
    function loadPage(page) {
      if (!checkAuth()) return;
      $('#pageTitle').text(page.charAt(0).toUpperCase() + page.slice(1).replace('-', ' '));
      switch (page) {
        case 'dashboard': loadDashboard(); break;
        case 'register': loadRegisterForm(); break;
        case 'view-all': loadAllStudents(); break;
        case 'create-admin': loadCreateAdmin(); break;
        case 'search': loadSearchForm(); break;
        default: loadDashboard();
      }
    }

    /*====================================
                   Dashboard
    ====================================*/
    async function loadDashboard() {
      try {
        const stats = await $.ajax({
          url: '/api/v1/admin/dashboard',
          method: 'GET'
        });
        $('#mainContent').html(`
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded shadow">
              <h3 class="text-xl font-bold">Total Students</h3>
              <p class="text-3xl">${stats.totalStudents || 0}</p>
            </div>
            <!-- Additional stats cards can be added here -->
          </div>
        `);
      } catch (error) {
        $('#mainContent').html(`<div class="text-red-500">Error loading dashboard data.</div>`);
      }
    }

    /*====================================
               Student Registration
    ====================================*/
    function loadRegisterForm() {
      $('#mainContent').html(`
        <div id="registrationSection">
          <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-bold mb-4">Register New Student</h2>
            <form id="studentRegistrationForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium">Matric</label>
                <input type="text" id="studentMatric" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">FirstName</label>
                <input type="text" id="studentFirstname" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">LastName</label>
                <input type="text" id="studentLastname" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">Gender</label>
                <select id="studentgender" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Course</label>
                <select id="course" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Course</option>
                  <option value="BSIT">BS Information Technology</option>
                  <option value="BSCS">BS Computer Science</option>
                  <option value="BSIS">BS Information Systems</option>
                  <option value="BSCE">BS Computer Engineering</option>
                  <option value="BSECE">BS Electronics Engineering</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Year Level</label>
                <select id="level" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Year Level</option>
                  <option value="1">First Year</option>
                  <option value="2">Second Year</option>
                  <option value="3">Third Year</option>
                  <option value="4">Fourth Year</option>
                  <option value="5">Fifth Year</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Section</label>
                <input type="text" id="section" class="w-full p-2 border rounded" placeholder="e.g., A, B, C" required>
              </div>
              <div class="flex justify-end space-x-2">
                <button type="button" id="clearFormBtn" class="px-4 py-2 bg-gray-300 rounded">Clear</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">
                  <i class="fas fa-user-plus mr-1"></i> Register
                </button>
              </div>
            </form>
            <div id="statusMessages" class="mt-4 hidden"></div>
          </div>
        </div>
        <div id="qrCodeSection" class="bg-white p-6 rounded shadow hidden">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-green-600">Registration Successful!</h2>
            <p class="mb-4">Student details:</p>
            <table class="mx-auto text-left">
              <tr><td class="font-bold">ID:</td><td id="studentIdDisplay"></td></tr>
              <tr><td class="font-bold">Matric:</td><td id="studentMatricDisplay"></td></tr>
              <tr><td class="font-bold">FirstName:</td><td id="studentFirstnameDisplay"></td></tr>
              <tr><td class="font-bold">LastName:</td><td id="studentLastnameDisplay"></td></tr>
              <tr><td class="font-bold">gender:</td><td id="studentgenderDisplay"></td></tr>
              <tr><td class="font-bold">Course:</td><td id="studentCourseDisplay"></td></tr>
              <tr><td class="font-bold">Year:</td><td id="studentLevelDisplay"></td></tr>
              <tr><td class="font-bold">Section:</td><td id="studentSectionDisplay"></td></tr>
            </table>
            <div id="qrCodeDisplay" class="mt-4 flex justify-center"></div>
            <div class="mt-4 space-x-2">
              <button id="printQrBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Print QR</button>
              <button id="registerAnotherBtn" class="px-4 py-2 bg-gray-600 text-white rounded">Register Another</button>
            </div>
          </div>
        </div>
      `);
      initRegisterFormHandlers();
    }

    function initRegisterFormHandlers() {
      $('#clearFormBtn').click(function() {
        $('#studentRegistrationForm')[0].reset();
        $('#statusMessages').addClass('hidden').empty();
      });
      $('#studentRegistrationForm').on('submit', async function(e) {
        e.preventDefault();
        await registerStudent();
      });
      $('#registerAnotherBtn').click(function() {
        $('#qrCodeSection').addClass('hidden');
        $('#registrationSection').removeClass('hidden');
        $('#studentRegistrationForm')[0].reset();
        $('#statusMessages').addClass('hidden').empty();
      });
      $('#printQrBtn').click(function() {
        printQRCode();
      });
    }

    async function registerStudent() {
      showStatusMessage('loading', 'Registering student...');
      const data = {
        Matric: $('#studentMatric').val().trim(),
        Firstname: $('#studentFirstname').val().trim(),
        Lastname: $('#studentLastname').val().trim(),
        gender: $('#studentgender').val(),
        course: $('#course').val(),
        level: $('#level').val(),
        section: $('#section').val().trim()
      };
      try {
        const student = await $.ajax({
          url: '/api/v1/admin/register-student',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data)
        });
        showStatusMessage('success', 'Student registered!');
        setTimeout(() => {
          displayStudentWithQR(student);
        }, 1000);
      } catch (error) {
        let msg = 'Registration failed';
        if (error.responseJSON && error.responseJSON.detail) {
          msg = error.responseJSON.detail;
        }
        showStatusMessage('error', msg);
      }
    }

    function showStatusMessage(type, message) {
      const statusDiv = $('#statusMessages');
      let icon = '', bgClass = '';
      switch (type) {
        case 'loading':
          icon = '<i class="fas fa-spinner fa-spin mr-2"></i>';
          bgClass = 'bg-blue-100 text-blue-800';
          break;
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          bgClass = 'bg-green-100 text-green-800';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          bgClass = 'bg-red-100 text-red-800';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2"></i>';
          bgClass = 'bg-gray-100 text-gray-800';
      }
      statusDiv.removeClass('hidden').html(`<div class="p-3 rounded ${bgClass}">${icon}${message}</div>`);
    }

    function displayStudentWithQR(student) {
      $('#registrationSection').addClass('hidden');
      $('#qrCodeSection').removeClass('hidden');
      $('#studentIdDisplay').text(student.id);
      $('#studentMatricDisplay').text(student.Matric);
      $('#studentFirstnameDisplay').text(student.Firstname);
      $('#studentLastnameDisplay').text(student.Lastname);
      $('#studentgenderDisplay').text(student.gender);
      $('#studentCourseDisplay').text(student.course);
      $('#studentLevelDisplay').text(student.level);
      $('#studentSectionDisplay').text(student.section);
      $.ajax({
        url: '/qr/generate',
        method: 'POST',
        data:{
          content: JSON.stringify({
            Matric: student.Matric,
            Firstname: student.Firstname,
            Lastname: student.Lastname,
            gender: student.gender,
            course: student.course,
            level: student.level,
            section: student.section
          }),
          size: 10
        }
      }).then(response => {
        if(response.svg) {
          $('#qrCodeDisplay').html(response.svg);
        } else {
          $('#qrCodeDisplay').html('<div class="text-red-500">QR Code generation failed</div>');
        }
      }).catch(error => {
        $('#qrCodeDisplay').html('<div class="text-red-500">QR Code generation failed</div>');
      });
    }

    function printQRCode() {
      const printWin = window.open('', '_blank');
      const studentInfo = `
        <div style="text-align:center; font-family: Arial, sans-serif; margin-bottom: 20px;">
          <h2>${$('#studentFirstnameDisplay').text()} ${$('#studentLastnameDisplay').text()}</h2>
          <p>Matric: ${$('#studentMatricDisplay').text()}</p>
          <p>FirstName: ${$('#studentFirstnameDisplay').text()}</p>
          <p>LastName: ${$('#studentLastnameDisplay').text()}</p>
          <p>Gender: ${$('#studentgenderDisplay').text()}</p>
          <p>Course: ${$('#studentCourseDisplay').text()}</p>
          <p>Year: ${$('#studentLevelDisplay').text()}</p>
          <p>Section: ${$('#studentSectionDisplay').text()}</p>
        </div>
      `;
      printWin.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Print QR Code</title>
          <style>
            body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
            @media print { @page { size: 80mm 100mm; margin: 0; } }
          </style>
        </head>
        <body>
          ${studentInfo}
          ${$('#qrCodeDisplay').html()}
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                window.close();
              }, 500);
            };
          <\/script>
        </body>
        </html>
      `);
      printWin.document.close();
    }

    /*====================================
                 View All Students
    ====================================*/
    async function loadAllStudents() {
      try {
        const students = await $.ajax({
          url: '/api/v1/admin/students',
          method: 'GET'
        });
        let tableRows = '';
        students.forEach(s => {
          tableRows += `
            <tr class="hover:bg-gray-100">
              <td class="px-4 py-2">${s.id || ''}</td>
              <td class="px-4 py-2">${s.Matric}</td>
              <td class="px-4 py-2">${s.Firstname}</td>
              <td class="px-4 py-2">${s.Lastname}</td>
              <td class="px-4 py-2">${s.gender}</td>
              <td class="px-4 py-2">${s.course}</td>
              <td class="px-4 py-2">${s.level}</td>
              <td class="px-4 py-2">${s.section}</td>
              <td class="px-4 py-2 text-right">
                <button class="view-btn text-blue-600 mr-2" data-matric="${s.Matric}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="edit-btn text-yellow-600 mr-2" data-matric="${s.Matric}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn text-red-600" data-matric="${s.Matric}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        $('#mainContent').html(`
          <div class="bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-bold mb-4">All Students</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full">
                <thead>
                  <tr class="bg-gray-200">
                    <th class="px-4 py-2">ID</th>
                    <th class="px-4 py-2">Matric</th>
                    <th class="px-4 py-2">FirstName</th>
                    <th class="px-4 py-2">LastName</th>
                    <th class="px-4 py-2">Gender</th>
                    <th class="px-4 py-2">Course</th>
                    <th class="px-4 py-2">Year</th>
                    <th class="px-4 py-2">Section</th>
                    <th class="px-4 py-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${tableRows}
                </tbody>
              </table>
            </div>
          </div>
        `);
        $('.view-btn').click(function() {
          const matric = $(this).data('matric');
          viewStudentDetails(matric);
        });
        $('.edit-btn').click(function() {
          const matric = $(this).data('matric');
          openEditModal(matric);
        });
        $('.delete-btn').click(function() {
          const matric = $(this).data('matric');
          openDeleteConfirmation(matric);
        });
      } catch (error) {
        $('#mainContent').html('<div class="text-red-500">Error loading students.</div>');
      }
    }

    /*====================================
             View Student Details
    ====================================*/
    async function viewStudentDetails(studentMatric) {
      try {
        const student = await $.ajax({
          url: `/api/v1/admin/students/${studentMatric}`,
          method: 'GET'
        });
        
        // Create a more attractive student details view
        const detailsHtml = `
          <div class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Student Details</h3>
                <button class="close-details text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="space-y-4">
                <div class="flex justify-center mb-4">
                  <div class="h-24 w-24 bg-indigo-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-4xl text-indigo-500"></i>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div class="font-medium">Matric:</div>
                  <div>${student.Matric}</div>
                  <div class="font-medium">Name:</div>
                  <div>${student.Firstname} ${student.Lastname}</div>
                  <div class="font-medium">Gender:</div>
                  <div>${student.gender}</div>
                  <div class="font-medium">Course:</div>
                  <div>${student.course}</div>
                  <div class="font-medium">Year Level:</div>
                  <div>${student.level}</div>
                  <div class="font-medium">Section:</div>
                  <div>${student.section}</div>
                </div>
                <div class="flex justify-end mt-4">
                  <button class="close-details px-4 py-2 bg-indigo-600 text-white rounded">Close</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        $('body').append(detailsHtml);
        $('.close-details').click(function() {
          $(this).closest('.fixed').remove();
        });
      } catch (error) {
        alert("Failed to load student details.");
      }
    }

    /*====================================
          Edit Student Functionality
    ====================================*/
    async function openEditModal(studentMatric) {
      try {
        const student = await $.ajax({
          url: `/api/v1/admin/students/${studentMatric}`,
          method: 'GET'
        });
        
        // Populate form fields
        $('#editStudentMatric').val(studentMatric);
        $('#editMatric').val(student.Matric);
        $('#editFirstname').val(student.Firstname);
        $('#editLastname').val(student.Lastname);
        $('#editGender').val(student.gender);
        $('#editCourse').val(student.course);
        $('#editLevel').val(student.level);
        $('#editSection').val(student.section);
        
        // Show modal
        $('#editStudentModal').removeClass('hidden').addClass('flex');
        
        // Setup event handlers
        $('#closeEditModal, #cancelEditBtn').off('click').on('click', function() {
          $('#editStudentModal').removeClass('flex').addClass('hidden');
          $('#editStatusMessages').addClass('hidden');
        });
        
        $('#editStudentForm').off('submit').on('submit', async function(e) {
          e.preventDefault();
          await updateStudent(studentMatric);
        });
      } catch (error) {
        alert("Failed to load student details for editing.");
      }
    }
    
    async function updateStudent(studentMatric) {
      const data = {
        Firstname: $('#editFirstname').val().trim(),
        Lastname: $('#editLastname').val().trim(),
        gender: $('#editGender').val(),
        course: $('#editCourse').val(),
        level: $('#editLevel').val(),
        section: $('#editSection').val().trim()
      };
      
      try {
        showEditStatusMessage('loading', 'Updating student information...');
        
        await $.ajax({
          url: `/api/v1/admin/students/${studentMatric}`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(data)
        });
        
        showEditStatusMessage('success', 'Student updated successfully!');
        
        setTimeout(() => {
          $('#editStudentModal').removeClass('flex').addClass('hidden');
          // Reload student list to show changes
          loadAllStudents();
        }, 1500);
      } catch (error) {
        let msg = 'Failed to update student';
        if (error.responseJSON && error.responseJSON.detail) {
          msg = error.responseJSON.detail;
        }
        showEditStatusMessage('error', msg);
      }
    }
    
    function showEditStatusMessage(type, message) {
      const statusDiv = $('#editStatusMessages');
      let icon = '', bgClass = '';
      switch (type) {
        case 'loading':
          icon = '<i class="fas fa-spinner fa-spin mr-2"></i>';
          bgClass = 'bg-blue-100 text-blue-800';
          break;
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          bgClass = 'bg-green-100 text-green-800';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          bgClass = 'bg-red-100 text-red-800';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2"></i>';
          bgClass = 'bg-gray-100 text-gray-800';
      }
      statusDiv.removeClass('hidden').html(`<div class="p-3 rounded ${bgClass}">${icon}${message}</div>`);
    }

    /*====================================
          Delete Student Functionality
    ====================================*/
    function openDeleteConfirmation(studentMatric) {
      $('#confirmDeleteBtn').data('matric', studentMatric);
      $('#confirmMessage').text(`Are you sure you want to delete student with Matric: ${studentMatric}?`);
      $('#confirmationModal').removeClass('hidden').addClass('flex');
      
      $('#cancelDeleteBtn').off('click').on('click', function() {
        $('#confirmationModal').removeClass('flex').addClass('hidden');
      });
      
      $('#confirmDeleteBtn').off('click').on('click', async function() {
        const matric = $(this).data('matric');
        await deleteStudent(matric);
      });
    }
    
    async function deleteStudent(studentMatric) {
      try {
        $('#confirmDeleteBtn').html('<i class="fas fa-spinner fa-spin mr-1"></i> Deleting...');
        $('#confirmDeleteBtn').prop('disabled', true);
        
        await $.ajax({
          url: `/api/v1/admin/students/${studentMatric}`,
          method: 'DELETE'
        });
        
        $('#confirmationModal').removeClass('flex').addClass('hidden');
        // Show success message
        const alertHtml = `
          <div class="fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 shadow-md" id="deleteAlert">
            <div class="flex">
              <div class="py-1"><i class="fas fa-check-circle"></i></div>
              <div class="ml-3">
                <p class="font-medium">Student deleted successfully!</p>
              </div>
              <div class="ml-auto pl-3">
                <button class="close-alert"><i class="fas fa-times"></i></button>
              </div>
            </div>
          </div>
        `;
        $('body').append(alertHtml);
        
        setTimeout(() => {
          $('#deleteAlert').remove();
          loadAllStudents(); // Reload student list
        }, 2000);
        
        $('.close-alert').click(function() {
          $('#deleteAlert').remove();
        });
      } catch (error) {
        $('#confirmDeleteBtn').html('Delete');
        $('#confirmDeleteBtn').prop('disabled', false);
        
        let errorMsg = 'Failed to delete student';
        if (error.responseJSON && error.responseJSON.detail) {
          errorMsg = error.responseJSON.detail;
        }
        
        $('#confirmMessage').html(`<div class="text-red-500 mt-2">${errorMsg}</div>`);
      }
    }

    /*====================================
              Search Functionality
    ====================================*/
    function loadSearchForm() {
      $('#mainContent').html(`
        <div class="bg-white p-6 rounded shadow">
          <h2 class="text-2xl font-bold mb-4">Search Students</h2>
          <form id="searchForm" class="mb-6">
            <div class="flex space-x-4">
              <div class="flex-1">
                <input type="text" id="searchQuery" class="w-full p-2 border rounded" 
                  placeholder="Search by Matric, Name, Course, or Level">
              </div>
              <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">
                <i class="fas fa-search mr-1"></i> Search
              </button>
            </div>
          </form>
          
          <div id="searchResults" class="mt-4">
            <p class="text-gray-500">Enter search terms above to find students.</p>
          </div>
        </div>
      `);
      
      $('#searchForm').on('submit', async function(e) {
        e.preventDefault();
        await searchStudents();
      });
    }
    
    async function searchStudents() {
      const query = $('#searchQuery').val().trim();
      if (!query) {
        $('#searchResults').html('<p class="text-yellow-500">Please enter a search term.</p>');
        return;
      }
      
      try {
        $('#searchResults').html(`
          <div class="flex justify-center">
            <i class="fas fa-spinner fa-spin text-indigo-600 text-3xl"></i>
          </div>
        `);
        
        // Get all students and filter on the client side
        const students = await $.ajax({
          url: '/api/v1/admin/students',
          method: 'GET'
        });
        
        // Filter based on the query
        const filteredStudents = students.filter(student => {
          const searchTerms = query.toLowerCase();
          return (
            student.Matric.toLowerCase().includes(searchTerms) ||
            student.Firstname.toLowerCase().includes(searchTerms) ||
            student.Lastname.toLowerCase().includes(searchTerms) ||
            student.course.toLowerCase().includes(searchTerms) ||
            student.level.toString().includes(searchTerms) ||
            student.section.toLowerCase().includes(searchTerms)
          );
        });
        
        if (filteredStudents.length === 0) {
          $('#searchResults').html('<p class="text-gray-500">No students found matching your search criteria.</p>');
          return;
        }
        
        let tableRows = '';
        filteredStudents.forEach(s => {
          tableRows += `
            <tr class="hover:bg-gray-100">
              <td class="px-4 py-2">${s.Matric}</td>
              <td class="px-4 py-2">${s.Firstname}</td>
              <td class="px-4 py-2">${s.Lastname}</td>
              <td class="px-4 py-2">${s.gender}</td>
              <td class="px-4 py-2">${s.course}</td>
              <td class="px-4 py-2">${s.level}</td>
              <td class="px-4 py-2">${s.section}</td>
              <td class="px-4 py-2 text-right">
                <button class="view-btn text-blue-600 mr-2" data-matric="${s.Matric}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="edit-btn text-yellow-600 mr-2" data-matric="${s.Matric}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn text-red-600" data-matric="${s.Matric}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
        
        $('#searchResults').html(`
          <h3 class="text-lg font-semibold mb-2">Search Results (${filteredStudents.length})</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gray-200">
                  <th class="px-4 py-2">Matric</th>
                  <th class="px-4 py-2">FirstName</th>
                  <th class="px-4 py-2">LastName</th>
                  <th class="px-4 py-2">Gender</th>
                  <th class="px-4 py-2">Course</th>
                  <th class="px-4 py-2">Year</th>
                  <th class="px-4 py-2">Section</th>
                  <th class="px-4 py-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `);
        
        // Add event listeners to action buttons
        $('.view-btn').click(function() {
          const matric = $(this).data('matric');
          viewStudentDetails(matric);
        });
        $('.edit-btn').click(function() {
          const matric = $(this).data('matric');
          openEditModal(matric);
        });
        $('.delete-btn').click(function() {
          const matric = $(this).data('matric');
          openDeleteConfirmation(matric);
        });
      } catch (error) {
        $('#searchResults').html('<p class="text-red-500">Error searching for students. Please try again.</p>');
      }
    }

    /*====================================
              Create Admin User
    ====================================*/
    function loadCreateAdmin() {
      $('#mainContent').html(`
        <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
          <h2 class="text-2xl font-bold mb-4">Create Admin User</h2>
          <form id="createAdminForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Full Name</label>
              <input type="text" id="adminName" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Email</label>
              <input type="email" id="adminEmail" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Password</label>
              <input type="password" id="adminPassword" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Confirm Password</label>
              <input type="password" id="confirmPassword" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">Admin Type</label>
              <select id="adminType" class="w-full p-2 border rounded" required>
                <option value="full">Full Access</option>
                <option value="limited">Limited Access</option>
              </select>
            </div>
            <div class="flex justify-end space-x-2">
              <button type="button" id="clearAdminFormBtn" class="px-4 py-2 bg-gray-300 rounded">Clear</button>
              <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">
                <i class="fas fa-user-shield mr-1"></i> Create Admin
              </button>
            </div>
          </form>
          <div id="adminStatusMessages" class="mt-4 hidden"></div>
        </div>
      `);
      
      $('#clearAdminFormBtn').click(function() {
        $('#createAdminForm')[0].reset();
        $('#adminStatusMessages').addClass('hidden').empty();
      });
      
      $('#createAdminForm').on('submit', async function(e) {
        e.preventDefault();
        // Password validation
        const password = $('#adminPassword').val();
        const confirmPassword = $('#confirmPassword').val();
        
        if (password !== confirmPassword) {
          showAdminStatusMessage('error', 'Passwords do not match');
          return;
        }
        
        await createAdminUser();
      });
    }
    
    async function createAdminUser() {
      showAdminStatusMessage('loading', 'Creating admin user...');
      
      const data = {
        name: $('#adminName').val().trim(),
        email: $('#adminEmail').val().trim(),
        password: $('#adminPassword').val(),
        is_full_access: $('#adminType').val() === 'full'
      };
      
      try {
        await $.ajax({
          url: '/api/v1/admin/create',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data)
        });
        
        showAdminStatusMessage('success', 'Admin user created successfully!');
        $('#createAdminForm')[0].reset();
      } catch (error) {
        let msg = 'Failed to create admin user';
        if (error.responseJSON && error.responseJSON.detail) {
          msg = error.responseJSON.detail;
        }
        showAdminStatusMessage('error', msg);
      }
    }
    
    function showAdminStatusMessage(type, message) {
      const statusDiv = $('#adminStatusMessages');
      let icon = '', bgClass = '';
      switch (type) {
        case 'loading':
          icon = '<i class="fas fa-spinner fa-spin mr-2"></i>';
          bgClass = 'bg-blue-100 text-blue-800';
          break;
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          bgClass = 'bg-green-100 text-green-800';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          bgClass = 'bg-red-100 text-red-800';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2"></i>';
          bgClass = 'bg-gray-100 text-gray-800';
      }
      statusDiv.removeClass('hidden').html(`<div class="p-3 rounded ${bgClass}">${icon}${message}</div>`);
    }

    /*====================================
            Application Initialization
    ====================================*/
    $(document).ready(function() {
      setupAjax();
      
      if (checkAuth()) {
        verifySession().then(valid => {
          if (valid) {
            loadPage('dashboard');
          }
        });
      }
      
      $('.nav-link').click(function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        loadPage(page);
      });
      
      $('#logoutBtn').click(function() {
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
      });
    });
  </script>
</body>
</html>
