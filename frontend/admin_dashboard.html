z<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <style>
    /* Custom animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translate3d(0, 20px, 0);
      }
      to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
      }
    }
    
    .student-card {
      animation: fadeInUp 0.5s ease;
    }
    
    .student-card:nth-child(2n) {
      animation-delay: 0.1s;
    }
    
    .student-card:nth-child(3n) {
      animation-delay: 0.2s;
    }
    
    /* Hover effects */
    .student-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Pulse animation for QR code */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
      }
    }
    
    #qrCodeDisplay svg {
      border-radius: 4px;
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <div class="bg-indigo-800 text-white w-64 py-6 flex flex-col">
      <div class="px-6 mb-8">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
      </div>
      <nav class="flex-1">
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="register">
          <i class="fas fa-user-plus w-6"></i>
          <span>Register Student</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="view-all">
          <i class="fas fa-users w-6"></i>
          <span>View All Students</span>
        </a>
        <a href="#" class="nav-link flex items-center px-6 py-3 hover:bg-indigo-700 transition-colors" data-page="search">
          <i class="fas fa-search w-6"></i>
          <span>Search Students</span>
        </a>
      </nav>
      <div class="px-6 pt-6">
        <button id="logoutBtn" class="w-full flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md transition-colors">
          <i class="fas fa-sign-out-alt w-6"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
      <!-- Top Bar -->
      <div class="bg-white shadow p-4 flex justify-between items-center">
        <h2 id="pageTitle" class="text-2xl font-semibold">Dashboard</h2>
        <div id="adminInfo" class="flex items-center">
          <span id="adminEmail" class="mr-2"></span>
          <i class="fas fa-user-circle text-2xl"></i>
        </div>
      </div>

      <!-- Dynamic Content -->
      <div id="mainContent" class="p-6 flex-1">
        <!-- Content loads here -->
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl animate__animated animate__zoomIn">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Edit Student</h3>
        <button id="closeEditModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editStudentForm" class="space-y-4">
        <input type="hidden" id="editStudentMatric">
        <div class="flex justify-center mb-6">
          <div class="relative">
            <div id="editImageUploadContainer" class="h-32 w-32 rounded-full flex items-center justify-center bg-indigo-100 cursor-pointer overflow-hidden hover:bg-indigo-200 transition-all">
              <img id="editStudentImagePreview" class="h-full w-full object-cover hidden" src="" alt="Student Image">
              <div id="editImageUploadIcon" class="text-center">
                <i class="fas fa-camera text-3xl text-indigo-500"></i>
                <p class="text-xs mt-1 text-indigo-500">Upload Photo</p>
              </div>
            </div>
            <input type="file" id="editStudentImage" class="hidden" accept="image/*">
            <button type="button" id="editRemoveImageBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition hidden">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Matric (readonly)</label>
            <input type="text" id="editMatric" class="w-full p-2 border rounded bg-gray-100" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium">First Name</label>
            <input type="text" id="editFirstname" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Last Name</label>
            <input type="text" id="editLastname" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium">Gender</label>
            <select id="editGender" class="w-full p-2 border rounded" required>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Course</label>
            <select id="editCourse" class="w-full p-2 border rounded" required>
              <option value="BSIT">BS Information Technology</option>
              <option value="BSCS">BS Computer Science</option>
              <option value="BSIS">BS Information Systems</option>
              <option value="BSCE">BS Computer Engineering</option>
              <option value="BSECE">BS Electronics Engineering</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Year Level</label>
            <select id="editLevel" class="w-full p-2 border rounded" required>
              <option value="1">First Year</option>
              <option value="2">Second Year</option>
              <option value="3">Third Year</option>
              <option value="4">Fourth Year</option>
              <option value="5">Fifth Year</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Section</label>
            <input type="text" id="editSection" class="w-full p-2 border rounded" required>
          </div>
        </div>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Save Changes</button>
        </div>
      </form>
      <div id="editStatusMessages" class="mt-4 hidden"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <div class="text-center">
        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
        <h3 class="text-xl font-bold mb-2">Confirm Delete</h3>
        <p id="confirmMessage" class="mb-6">Are you sure you want to delete this student?</p>
        <div class="flex justify-center space-x-4">
          <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
          <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables - declare once at the top level
    let uploadedImageData = '';
    let editUploadedImageData = '';
    
    /*==================================================
      Authentication & AJAX Setup
    ==================================================*/
    function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/admin/login';
        return false;
      }
      return true;
    }

    async function verifySession() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          window.location.href = '/admin/login';
          return false;
        }

        const response = await $.ajax({
          url: '/api/v1/admin/me',
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response || !response.email) {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin/login';
          return false;
        }

        $('#adminEmail').text(response.email);
        return true;
      } catch (error) {
        console.error("Session verification failed:", error);
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
        return false;
      }
    }

    function setupAjax() {
      $.ajaxSetup({
        beforeSend: function(xhr) {
          const token = localStorage.getItem('adminToken');
          if (token) {
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
          }
        },
        error: function(xhr) {
          if (xhr.status === 401 || xhr.status === 403) {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
          }
        }
      });
    }

    /*====================================
         Page Navigation & Loader
    ====================================*/
    function loadPage(page) {
      if (!checkAuth()) return;
      $('#pageTitle').text(page.charAt(0).toUpperCase() + page.slice(1).replace('-', ' '));
      switch (page) {
        case 'register': loadRegisterForm(); break;
        case 'view-all': loadAllStudents(); break;
        case 'search': loadSearchForm(); break;
        default: loadRegisterForm();
      }
    }

    /*====================================
                   Dashboard
    ====================================*/
    // Dashboard functionality removed

    /*====================================
               Student Registration
    ====================================*/
    function loadRegisterForm() {
      $('#mainContent').html(`
        <div id="registrationSection" class="animate__animated animate__fadeIn">
          <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-bold mb-4">Register New Student</h2>
            <form id="studentRegistrationForm" class="space-y-4">
              <div class="flex justify-center mb-6">
                <div class="relative">
                  <div id="imageUploadContainer" class="h-32 w-32 rounded-full flex items-center justify-center bg-indigo-100 cursor-pointer overflow-hidden hover:bg-indigo-200 transition-all">
                    <img id="studentImagePreview" class="h-full w-full object-cover hidden" src="" alt="Student Image">
                    <div id="imageUploadIcon" class="text-center">
                      <i class="fas fa-camera text-3xl text-indigo-500"></i>
                      <p class="text-xs mt-1 text-indigo-500">Upload Photo</p>
                    </div>
                  </div>
                  <input type="file" id="studentImage" class="hidden" accept="image/*">
                  <button type="button" id="removeImageBtn" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition hidden">
                    <i class="fas fa-times text-xs"></i>
                  </button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium">Matric</label>
                <input type="text" id="studentMatric" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">FirstName</label>
                <input type="text" id="studentFirstname" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">LastName</label>
                <input type="text" id="studentLastname" class="w-full p-2 border rounded" required>
              </div>
              <div>
                <label class="block text-sm font-medium">Gender</label>
                <select id="studentgender" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Course</label>
                <select id="course" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Course</option>
                  <option value="BSIT">BS Information Technology</option>
                  <option value="BSCS">BS Computer Science</option>
                  <option value="BSIS">BS Information Systems</option>
                  <option value="BSCE">BS Computer Engineering</option>
                  <option value="BSECE">BS Electronics Engineering</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Year Level</label>
                <select id="level" class="w-full p-2 border rounded" required>
                  <option value="" disabled selected>Select Year Level</option>
                  <option value="1">First Year</option>
                  <option value="2">Second Year</option>
                  <option value="3">Third Year</option>
                  <option value="4">Fourth Year</option>
                  <option value="5">Fifth Year</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Section</label>
                <input type="text" id="section" class="w-full p-2 border rounded" placeholder="e.g., A, B, C" required>
              </div>
              <div class="flex justify-end space-x-2">
                <button type="button" id="clearFormBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">Clear</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                  <i class="fas fa-user-plus mr-1"></i> Register
                </button>
              </div>
            </form>
            <div id="statusMessages" class="mt-4 hidden"></div>
          </div>
        </div>
        <div id="qrCodeSection" class="bg-white p-6 rounded shadow hidden animate__animated animate__fadeIn">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-green-600 mb-4">Registration Successful!</h2>
            <div class="flex justify-center mb-4">
              <img id="studentImageDisplay" class="h-32 w-32 rounded-full object-cover" src="" alt="Student Image">
            </div>
            <p class="mb-4">Student details:</p>
            <table class="mx-auto text-left">
              <tr><td class="font-bold pr-4">ID:</td><td id="studentIdDisplay"></td></tr>
              <tr><td class="font-bold pr-4">Matric:</td><td id="studentMatricDisplay"></td></tr>
              <tr><td class="font-bold pr-4">FirstName:</td><td id="studentFirstnameDisplay"></td></tr>
              <tr><td class="font-bold pr-4">LastName:</td><td id="studentLastnameDisplay"></td></tr>
              <tr><td class="font-bold pr-4">Gender:</td><td id="studentgenderDisplay"></td></tr>
              <tr><td class="font-bold pr-4">Course:</td><td id="studentCourseDisplay"></td></tr>
              <tr><td class="font-bold pr-4">Year:</td><td id="studentLevelDisplay"></td></tr>
              <tr><td class="font-bold pr-4">Section:</td><td id="studentSectionDisplay"></td></tr>
            </table>
            <div id="qrCodeDisplay" class="mt-6 flex justify-center"></div>
            <div class="mt-6 space-x-4">
              <button id="downloadQrBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                <i class="fas fa-download mr-1"></i> Download QR Code
              </button>
              <button id="registerAnotherBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                <i class="fas fa-plus-circle mr-1"></i> Register Another
              </button>
            </div>
          </div>
        </div>
      `);
      // Initialize the upload handlers and clear any previous image data
      uploadedImageData = '';
      initRegisterFormHandlers();
      initImageUploadHandlers();
    }
    
    function initRegisterFormHandlers() {
      $('#clearFormBtn').click(function() {
        $('#studentRegistrationForm')[0].reset();
        $('#statusMessages').addClass('hidden').empty();
        // Reset image preview
        $('#studentImagePreview').attr('src', '').addClass('hidden');
        $('#imageUploadIcon').show();
        $('#removeImageBtn').addClass('hidden');
      });
      
      $('#studentRegistrationForm').on('submit', async function(e) {
        e.preventDefault();
        await registerStudent();
      });
      
      $('#registerAnotherBtn').click(function() {
        $('#qrCodeSection').addClass('hidden');
        $('#registrationSection').removeClass('hidden');
        $('#studentRegistrationForm')[0].reset();
        $('#statusMessages').addClass('hidden').empty();
        // Reset image preview
        $('#studentImagePreview').attr('src', '').addClass('hidden');
        $('#imageUploadIcon').show();
        $('#removeImageBtn').addClass('hidden');
      });
      
      $('#downloadQrBtn').click(function() {
        downloadQRCode();
      });
    }
    
    function initImageUploadHandlers() {
      $('#imageUploadContainer').off('click').on('click', function() {
        $('#studentImage').click();
      });
      
      $('#studentImage').off('change').on('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          if (file.size > 10 * 1024 * 1024) {
            showStatusMessage('error', 'Image file size must be less than 10MB');
            return;
          }
          if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
            showStatusMessage('error', 'Only JPG, PNG, and GIF images are allowed');
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            uploadedImageData = e.target.result;
            $('#studentImagePreview').attr('src', uploadedImageData).removeClass('hidden');
            $('#imageUploadIcon').hide();
            $('#removeImageBtn').removeClass('hidden');
            // Clear any error messages
            $('#statusMessages').addClass('hidden').empty();
          };
          reader.onerror = function() {
            showStatusMessage('error', 'Error reading image file');
          };
          reader.readAsDataURL(file);
        }
      });
      
      $('#removeImageBtn').off('click').on('click', function(e) {
        e.stopPropagation(); // Prevent triggering the container click
        uploadedImageData = '';
        $('#studentImagePreview').attr('src', '').addClass('hidden');
        $('#imageUploadIcon').show();
        $('#removeImageBtn').addClass('hidden');
        $('#studentImage').val(''); // Clear the file input
      });
    }
    
    async function registerStudent() {
      showStatusMessage('loading', 'Registering student...');
      const data = {
        Matric: $('#studentMatric').val().trim(),
        Firstname: $('#studentFirstname').val().trim(),
        Lastname: $('#studentLastname').val().trim(),
        gender: $('#studentgender').val(),
        course: $('#course').val(),
        level: $('#level').val(),
        section: $('#section').val().trim(),
        image: uploadedImageData || null // Add the image data if available
      };
      try {
        const student = await $.ajax({
          url: '/api/v1/admin/register-student',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data)
        });
        showStatusMessage('success', 'Student registered!');
        setTimeout(() => {
          displayStudentWithQR(student);
        }, 1000);
      } catch (error) {
        let msg = 'Registration failed';
        if (error.responseJSON && error.responseJSON.detail) {
          msg = error.responseJSON.detail;
        }
        showStatusMessage('error', msg);
      }
    }

    function showStatusMessage(type, message) {
      const statusDiv = $('#statusMessages');
      let icon = '', bgClass = '';
      switch (type) {
        case 'loading':
          icon = '<i class="fas fa-spinner fa-spin mr-2"></i>';
          bgClass = 'bg-blue-100 text-blue-800';
          break;
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          bgClass = 'bg-green-100 text-green-800';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          bgClass = 'bg-red-100 text-red-800';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2"></i>';
          bgClass = 'bg-gray-100 text-gray-800';
      }
      statusDiv.removeClass('hidden').html(`<div class="p-3 rounded ${bgClass}">${icon}${message}</div>`);
    }

    function displayStudentWithQR(student) {
      $('#registrationSection').addClass('hidden');
      $('#qrCodeSection').removeClass('hidden').addClass('animate__animated animate__fadeIn');
      $('#studentIdDisplay').text(student.id);
      $('#studentMatricDisplay').text(student.Matric);
      $('#studentFirstnameDisplay').text(student.Firstname);
      $('#studentLastnameDisplay').text(student.Lastname);
      $('#studentgenderDisplay').text(student.gender);
      $('#studentCourseDisplay').text(student.course);
      $('#studentLevelDisplay').text(student.level);
      $('#studentSectionDisplay').text(student.section);
      
      if (student.image) {
        $('#studentImageDisplay').attr('src', student.image).show();
      } else {
        $('#studentImageDisplay').hide();
        $('#studentImageDisplay').after('<div class="mx-auto h-32 w-32 bg-indigo-100 rounded-full flex items-center justify-center"><i class="fas fa-user text-4xl text-indigo-500"></i></div>');
      }
      
      // Construct the URL pointing to the student's information page
      const studentUrl = window.location.origin + '/student/' + student.Matric;
      console.log('Generating QR for URL:', studentUrl); // Log the URL
      
    
      
      $.ajax({
        url: '/qr/generate',
        method: 'POST',
        data:{
          content: studentUrl,
          size: 10
        } // Ensure we send JSON
        
      }).then(response => {
        if(response.svg) {
          $('#qrCodeDisplay').html(response.svg);
          // Enable download button
          $('#downloadQrBtn').prop('disabled', false).removeClass('opacity-50');
        } else {
          $('#qrCodeDisplay').html('<div class="text-red-500">QR Code generation failed</div>');
          $('#downloadQrBtn').prop('disabled', true).addClass('opacity-50');
        }
      }).catch(error => {
        $('#qrCodeDisplay').html('<div class="text-red-500">QR Code generation failed</div>');
        $('#downloadQrBtn').prop('disabled', true).addClass('opacity-50');
      });
    }
    
    function downloadQRCode() {
      const qrCodeElement = document.querySelector('#qrCodeDisplay svg');
      if (!qrCodeElement) {
        console.error("QR code element not found");
        return;
      }

      try {
        // Make the SVG render properly on the canvas by setting dimensions explicitly
        const svgData = new XMLSerializer().serializeToString(qrCodeElement);
        const svgWidth = qrCodeElement.width.baseVal.value || 200;
        const svgHeight = qrCodeElement.height.baseVal.value || 200;
        
        // Create a sized canvas
        const canvas = document.createElement('canvas');
        const scale = 3; // Scale up for better quality
        canvas.width = svgWidth * scale;
        canvas.height = svgHeight * scale;
        
        // Create a Blob with the SVG data
        const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        
        // Draw on canvas when image loads
        const img = new Image();
        img.onload = function() {
          // Draw white background first
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // Draw the QR code
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);
          
          // Create downloadable PNG
          try {
            const pngUrl = canvas.toDataURL('image/png');
            
            // Force download via dynamic link
            const a = document.createElement('a');
            const studentMatric = $('#studentMatricDisplay').text();
            a.download = `student_qr_code_${studentMatric || 'download'}.png`;
            a.href = pngUrl;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          } catch (e) {
            console.error("Error in canvas conversion", e);
            alert("Failed to download QR code. Please try again.");
          }
        };
        
        img.onerror = function(e) {
          console.error("Image loading error", e);
          URL.revokeObjectURL(url);
          alert("Failed to process QR code for download.");
        };
        
        img.src = url;
      } catch (e) {
        console.error("QR code download failed", e);
        alert("QR code download failed. Please try again.");
      }
    }

    /*====================================
                 View All Students
    ====================================*/
    function loadAllStudents() {
      $('#mainContent').html(`
        <div class="bg-white p-6 rounded shadow animate__animated animate__fadeIn">
          <h2 class="text-2xl font-bold mb-6">All Students</h2>
          <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
      `);
      
      $.ajax({
        url: '/api/v1/admin/students',
        method: 'GET',
        success: function(students) {
          const studentList = document.getElementById('studentList');
          studentList.innerHTML = '';
          
          if (students.length === 0) {
            studentList.innerHTML = `
              <div class="col-span-full text-center py-8">
                <i class="fas fa-users text-gray-300 text-5xl mb-3"></i>
                <p class="text-gray-500">No students registered yet</p>
              </div>
            `;
            return;
          }
          
          students.forEach(student => {
            const studentCard = document.createElement('div');
            studentCard.className = 'student-card bg-white p-4 rounded shadow border border-gray-200 hover:shadow-lg transition-all transform hover:-translate-y-1 duration-200';
            studentCard.innerHTML = `
              <div class="student-image-container flex justify-center mb-4">
                ${student.image ? 
                  `<img src="${student.image}" alt="${student.Firstname}" class="h-24 w-24 rounded-full object-cover">` :
                  `<div class="h-24 w-24 bg-indigo-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-4xl text-indigo-500"></i>
                  </div>`
                }
              </div>
              <div class="student-info text-center mb-4">
                <h3 class="text-lg font-semibold">${student.Firstname} ${student.Lastname}</h3>
                <p class="text-sm text-gray-600"><strong>Matric:</strong> ${student.Matric}</p>
                <p class="text-sm text-gray-600"><strong>Course:</strong> ${student.course}</p>
                <p class="text-sm text-gray-600"><strong>Level:</strong> ${student.level}</p>
              </div>
              <div class="student-actions flex justify-center space-x-2">
                <button onclick="editStudent(${JSON.stringify(student).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button onclick="deleteStudent('${student.Matric}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            `;
            studentList.appendChild(studentCard);
          });
        },
        error: function() {
          $('#studentList').html(`
            <div class="col-span-full">
              <div class="text-red-500">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Error loading students. Please try again.
              </div>
            </div>
          `);
        }
      });
    }

    /*====================================
             View Student Details
    ====================================*/
    async function viewStudentDetails(student) {
      try {
        // If student object is passed as a matric string, fetch the student data.
        if (typeof student === 'string') {
          student = await $.ajax({
            url: `/api/v1/admin/students/${student}`,
            method: 'GET'
          });
        }
        
        // Build student image HTML.
        const studentImage = student.image ? 
          `<img src="${student.image}" alt="${student.Firstname}" class="h-32 w-32 rounded-full object-cover">` : 
          `<div class="h-32 w-32 bg-indigo-100 rounded-full flex items-center justify-center">
             <i class="fas fa-user text-4xl text-indigo-500"></i>
           </div>`;

        // Construct a URL pointing to the public student details page.
        const studentUrl = window.location.origin + '/student/' + student.Matric;
        
        // Generate QR code by sending the URL as a JSON payload.
        const qrResponse = await $.ajax({
          url: '/qr/generate',
          method: 'POST',
          data: JSON.stringify({
            content: studentUrl,
            size: 10
          }),
          contentType: 'application/json'
        });

        // If the response contains an SVG, wrap it in a container for later access.
        let qrCodeHtml = '';
        if (qrResponse && qrResponse.svg) {
          qrCodeHtml = `<div id="qrCodeContainer">${qrResponse.svg}</div>`;
        } else {
          qrCodeHtml = '<div class="text-red-500">QR Code generation failed</div>';
        }
        
        // Build the modal HTML.
        const detailsHtml = `
          <div id="studentDetailsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 animate__animated animate__fadeIn">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full animate__animated animate__zoomIn">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Student Details</h3>
                <button class="close-details text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="space-y-4">
                <div class="flex justify-center mb-4">
                  ${studentImage}
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div class="font-medium">Matric:</div>
                  <div>${student.Matric}</div>
                  <div class="font-medium">Name:</div>
                  <div>${student.Firstname} ${student.Lastname}</div>
                  <div class="font-medium">Gender:</div>
                  <div>${student.gender}</div>
                  <div class="font-medium">Course:</div>
                  <div>${student.course}</div>
                  <div class="font-medium">Year Level:</div>
                  <div>${student.level}</div>
                  <div class="font-medium">Section:</div>
                  <div>${student.section}</div>
                </div>
                <div class="mt-4">
                  <h4 class="font-medium mb-2">QR Code:</h4>
                  <div class="flex justify-center" id="qrCodeWrapper">
                    ${qrCodeHtml}
                  </div>
                  <div class="flex justify-center mt-4">
                    <button onclick="downloadStudentQRCode('${student.Matric}')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                      <i class="fas fa-download mr-1"></i> Download QR Code
                    </button>
                  </div>
                </div>
                <div class="flex justify-end mt-4">
                  <button class="close-details px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Close</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        $('body').append(detailsHtml);
        $('.close-details').off('click').on('click', function() {
          $('#studentDetailsModal').remove();
        });
      } catch (error) {
        console.error('Error loading student details:', error);
        alert("Failed to load student details.");
      }
    }

    function downloadStudentQRCode(matric) {
      // Select the SVG element from our designated container.
      const qrCodeElement = document.querySelector('#qrCodeContainer svg');
      if (!qrCodeElement) return;

      // Create a canvas and get its context.
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      // Use the SVG's bounding box to set canvas dimensions.
      const bbox = qrCodeElement.getBBox();
      canvas.width = bbox.width;
      canvas.height = bbox.height;
      
      // Serialize the SVG into a string.
      const svgData = new XMLSerializer().serializeToString(qrCodeElement);
      const img = new Image();
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      
      // Once the image loads, draw it on the canvas.
      img.onload = function() {
        context.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        
        // Convert the canvas content to a PNG data URL.
        const pngUrl = canvas.toDataURL('image/png');
        const downloadLink = document.createElement('a');
        downloadLink.href = pngUrl;
        downloadLink.download = `student_qr_code_${matric}.png`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      };
      img.src = url;
    }

    /*====================================
              Search Functionality
    ====================================*/
    function loadSearchForm() {
      $('#mainContent').html(`
        <div class="bg-white p-6 rounded shadow animate__animated animate__fadeIn">
          <h2 class="text-2xl font-bold mb-4">Search Students</h2>
          <form id="searchForm" class="mb-6">
            <div class="flex space-x-4">
              <div class="flex-1 relative">
                <input type="text" id="searchQuery" class="w-full p-3 pl-10 border rounded" 
                  placeholder="Search by Matric, Name, Course, or Level">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              </div>
              <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                Search
              </button>
            </div>
          </form>
          
          <div id="searchResults" class="mt-6">
            <div class="flex flex-col items-center justify-center py-8 text-gray-500">
              <i class="fas fa-search text-5xl mb-4 text-indigo-200"></i>
              <p>Enter search terms above to find students.</p>
            </div>
          </div>
        </div>
      `);
      
      $('#searchForm').on('submit', async function(e) {
        e.preventDefault();
        await searchStudents();
      });
      
      // Add animation to search input
      $('#searchQuery').on('focus', function() {
        $(this).addClass('ring-2 ring-indigo-300 transition-all');
      }).on('blur', function() {
        $(this).removeClass('ring-2 ring-indigo-300');
      });
    }
    
    async function searchStudents() {
      const query = $('#searchQuery').val().trim();
      if (!query) {
        $('#searchResults').html(`
          <div class="flex flex-col items-center justify-center py-8 bg-yellow-50 rounded text-yellow-700">
            <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
            <p>Please enter a search term.</p>
          </div>
        `);
        return;
      }
      
      try {
        $('#searchResults').html(`
          <div class="flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
          </div>
        `);
        
        // Get all students and filter on the client side
        const students = await $.ajax({
          url: '/api/v1/admin/students',
          method: 'GET'
        });
        
        // Filter based on the query
        const filteredStudents = students.filter(student => {
          const searchTerms = query.toLowerCase();
          return (
            student.Matric.toLowerCase().includes(searchTerms) ||
            student.Firstname.toLowerCase().includes(searchTerms) ||
            student.Lastname.toLowerCase().includes(searchTerms) ||
            student.course.toLowerCase().includes(searchTerms) ||
            student.level.toString().includes(searchTerms) ||
            student.section.toLowerCase().includes(searchTerms)
          );
        });
        
        if (filteredStudents.length === 0) {
          $('#searchResults').html(`
            <div class="flex flex-col items-center justify-center py-8 bg-gray-50 rounded">
              <i class="fas fa-search text-4xl mb-3 text-gray-300"></i>
              <p class="text-gray-600">No students found matching your search criteria.</p>
            </div>
          `);
          return;
        }
        
        let searchResultsHTML = `
          <h3 class="text-lg font-semibold mb-4">Search Results (${filteredStudents.length})</h3>
          <div id="searchResultsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        `;
        
        filteredStudents.forEach(student => {
          searchResultsHTML += `
            <div class="student-card bg-white p-4 rounded shadow border border-gray-200 hover:shadow-lg transition-all transform hover:-translate-y-1 duration-200 animate__animated animate__fadeIn">
              <div class="student-image-container flex justify-center mb-4">
                ${student.image ? 
                  `<img src="${student.image}" alt="${student.Firstname}" class="h-24 w-24 rounded-full object-cover">` :
                  `<div class="h-24 w-24 bg-indigo-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-4xl text-indigo-500"></i>
                  </div>`
                }
              </div>
              <div class="student-info text-center mb-4">
                <h3 class="text-lg font-semibold">${student.Firstname} ${student.Lastname}</h3>
                <p class="text-sm text-gray-600"><strong>Matric:</strong> ${student.Matric}</p>
                <p class="text-sm text-gray-600"><strong>Course:</strong> ${student.course}</p>
                <p class="text-sm text-gray-600"><strong>Level:</strong> ${student.level}</p>
              </div>
              <div class="student-actions flex justify-center space-x-2">
                <button class="view-student-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition" data-student='${JSON.stringify(student).replace(/'/g, "&apos;")}'>
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="edit-student-btn px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition" data-student='${JSON.stringify(student).replace(/'/g, "&apos;")}'>
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-student-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition" data-matric="${student.Matric}">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `;
        });
        
        searchResultsHTML += `</div>`;
        $('#searchResults').html(searchResultsHTML);
        
        // Add event listeners after the HTML is rendered
        $('.view-student-btn').on('click', async function() {
          const studentData = JSON.parse($(this).data('student'));
          await viewStudentDetails(studentData);
        });
        
        $('.edit-student-btn').on('click', async function() {
          const studentData = JSON.parse($(this).data('student'));
          await editStudent(studentData);
        });
        
        $('.delete-student-btn').on('click', async function() {
          const matric = $(this).data('matric');
          const studentCard = $(this).closest('.student-card');
          try {
            // Show confirmation modal
            $('#confirmationModal').removeClass('hidden');
            $('#confirmMessage').text(`Are you sure you want to delete student with matric number ${matric}?`);
            
            // Handle confirmation
            $('#confirmDeleteBtn').off('click').on('click', async function() {
              try {
                await $.ajax({
                  url: `/api/v1/admin/students/${matric}`,
                  method: 'DELETE'
                });
                
                // Close confirmation modal
                $('#confirmationModal').addClass('hidden');
                
                // Remove the student card immediately
                studentCard.fadeOut(300, function() {
                  $(this).remove();
                  
                  // If this was the last card, show empty state
                  if ($('.student-card').length === 0) {
                    $('#searchResults').html(`
                      <div class="flex flex-col items-center justify-center py-8 bg-gray-50 rounded">
                        <i class="fas fa-search text-4xl mb-3 text-gray-300"></i>
                        <p class="text-gray-600">No students found.</p>
                      </div>
                    `);
                  }
                });
                
                // Show success message
                showStatusMessage('success', 'Student deleted successfully!');
              } catch (error) {
                let msg = 'Failed to delete student';
                if (error.responseJSON && error.responseJSON.detail) {
                  msg = error.responseJSON.detail;
                }
                showStatusMessage('error', msg);
              }
            });
            
            // Handle cancel
            $('#cancelDeleteBtn').off('click').on('click', function() {
              $('#confirmationModal').addClass('hidden');
            });
          } catch (error) {
            console.error('Error in delete confirmation:', error);
            showStatusMessage('error', 'Error processing delete request');
          }
        });
      } catch (error) {
        $('#searchResults').html(`
          <div class="flex flex-col items-center justify-center py-8 bg-red-50 rounded text-red-700">
            <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
            <p>Error searching for students. Please try again.</p>
          </div>
        `);
      }
    }    

    /*====================================
          Edit Student Shortcut Function
    ====================================*/
    async function editStudent(student) {
      // If a student object is passed, extract the matric number
      const matric = typeof student === 'string' ? student : student.Matric;
      try {
        // Fetch the latest student data
        const studentData = await $.ajax({
          url: `/api/v1/admin/students/${matric}`,
          method: 'GET'
        });
        openEditModal(studentData);
      } catch (error) {
        showStatusMessage('error', 'Failed to load student data for editing');
      }
    }

    function openEditModal(student) {
      // Populate the form with student data
      $('#editStudentMatric').val(student.Matric);
      $('#editMatric').val(student.Matric);
      $('#editFirstname').val(student.Firstname);
      $('#editLastname').val(student.Lastname);
      $('#editGender').val(student.gender);
      $('#editCourse').val(student.course);
      $('#editLevel').val(student.level);
      $('#editSection').val(student.section);
      
      // Handle image preview
      if (student.image) {
        $('#editStudentImagePreview').attr('src', student.image).removeClass('hidden');
        $('#editImageUploadIcon').hide();
        $('#editRemoveImageBtn').removeClass('hidden');
      } else {
        $('#editStudentImagePreview').attr('src', '').addClass('hidden');
        $('#editImageUploadIcon').show();
        $('#editRemoveImageBtn').addClass('hidden');
      }
      
      // Show the modal
      $('#editStudentModal').removeClass('hidden');
      
      // Initialize image upload handlers
      initEditImageUploadHandlers();
      
      // Initialize form submission handler
      initEditFormHandlers();
    }

    function initEditImageUploadHandlers() {
      $('#editImageUploadContainer').off('click').on('click', function() {
        $('#editStudentImage').click();
      });
      
      $('#editStudentImage').off('change').on('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          if (file.size > 10 * 1024 * 1024) {
            showEditStatusMessage('error', 'Image file size must be less than 10MB');
            return;
          }
          if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
            showEditStatusMessage('error', 'Only JPG, PNG, and GIF images are allowed');
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            editUploadedImageData = e.target.result;
            $('#editStudentImagePreview').attr('src', editUploadedImageData).removeClass('hidden');
            $('#editImageUploadIcon').hide();
            $('#editRemoveImageBtn').removeClass('hidden');
            $('#editStatusMessages').addClass('hidden').empty();
          };
          reader.onerror = function() {
            showEditStatusMessage('error', 'Error reading image file');
          };
          reader.readAsDataURL(file);
        }
      });
      
      $('#editRemoveImageBtn').off('click').on('click', function(e) {
        e.stopPropagation();
        editUploadedImageData = '';
        $('#editStudentImagePreview').attr('src', '').addClass('hidden');
        $('#editImageUploadIcon').show();
        $('#editRemoveImageBtn').addClass('hidden');
        $('#editStudentImage').val('');
      });
    }

    function initEditFormHandlers() {
      $('#editStudentForm').off('submit').on('submit', async function(e) {
        e.preventDefault();
        await updateStudent();
      });
      
      $('#cancelEditBtn').off('click').on('click', function() {
        $('#editStudentModal').addClass('hidden');
        $('#editStatusMessages').addClass('hidden').empty();
      });
      
      $('#closeEditModal').off('click').on('click', function() {
        $('#editStudentModal').addClass('hidden');
        $('#editStatusMessages').addClass('hidden').empty();
      });
    }

    async function updateStudent() {
      const matric = $('#editStudentMatric').val();
      showEditStatusMessage('loading', 'Updating student...');
      
      const data = {
        Matric: $('#editMatric').val().trim(),
        Firstname: $('#editFirstname').val().trim(),
        Lastname: $('#editLastname').val().trim(),
        gender: $('#editGender').val(),
        course: $('#editCourse').val(),
        level: $('#editLevel').val(),
        section: $('#editSection').val().trim(),
        image: editUploadedImageData || null
      };
      
      try {
        const updatedStudent = await $.ajax({
          url: `/api/v1/admin/students/${matric}`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(data)
        });
        
        showEditStatusMessage('success', 'Student updated successfully!');
        setTimeout(() => {
          $('#editStudentModal').addClass('hidden');
          loadAllStudents(); // Refresh the student list
        }, 1000);
      } catch (error) {
        let msg = 'Update failed';
        if (error.responseJSON && error.responseJSON.detail) {
          msg = error.responseJSON.detail;
        }
        showEditStatusMessage('error', msg);
      }
    }

    function showEditStatusMessage(type, message) {
      const statusDiv = $('#editStatusMessages');
      let icon = '', bgClass = '';
      switch (type) {
        case 'loading':
          icon = '<i class="fas fa-spinner fa-spin mr-2"></i>';
          bgClass = 'bg-blue-100 text-blue-800';
          break;
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          bgClass = 'bg-green-100 text-green-800';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          bgClass = 'bg-red-100 text-red-800';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2"></i>';
          bgClass = 'bg-gray-100 text-gray-800';
      }
      statusDiv.removeClass('hidden').html(`<div class="p-3 rounded ${bgClass}">${icon}${message}</div>`);
    }

    /*====================================
              Delete Student Function
    ====================================*/
    async function deleteStudent(matric) {
      const studentCard = $(`button[onclick="deleteStudent('${matric}')"]`).closest('.student-card');
      try {
        // Show confirmation modal
        $('#confirmationModal').removeClass('hidden');
        $('#confirmMessage').text(`Are you sure you want to delete student with matric number ${matric}?`);
        
        // Handle confirmation
        $('#confirmDeleteBtn').off('click').on('click', async function() {
          try {
            await $.ajax({
              url: `/api/v1/admin/students/${matric}`,
              method: 'DELETE'
            });
            
            // Close confirmation modal
            $('#confirmationModal').addClass('hidden');
            
            // Remove the student card immediately
            studentCard.fadeOut(300, function() {
              $(this).remove();
              
              // If this was the last card, show empty state
              if ($('.student-card').length === 0) {
                $('#studentList').html(`
                  <div class="col-span-full text-center py-8">
                    <i class="fas fa-users text-gray-300 text-5xl mb-3"></i>
                    <p class="text-gray-500">No students registered yet</p>
                  </div>
                `);
              }
            });
            
            // Show success message
            showStatusMessage('success', 'Student deleted successfully!');
          } catch (error) {
            let msg = 'Failed to delete student';
            if (error.responseJSON && error.responseJSON.detail) {
              msg = error.responseJSON.detail;
            }
            showStatusMessage('error', msg);
          }
        });
        
        // Handle cancel
        $('#cancelDeleteBtn').off('click').on('click', function() {
          $('#confirmationModal').addClass('hidden');
        });
      } catch (error) {
        console.error('Error in delete confirmation:', error);
        showStatusMessage('error', 'Error processing delete request');
      }
    }

    /*====================================
            Application Initialization
    ====================================*/
    $(document).ready(function() {
      setupAjax();
      
      // Always verify session on page load
      verifySession().then(valid => {
        if (!valid) {
          return;
        }
        // Default page is now register instead of dashboard
        loadPage('register');
      });
      
      $('.nav-link').click(function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        loadPage(page);
      });
      
      $('#logoutBtn').click(function() {
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
      });
      
      // Add active class to sidebar links
      $('.nav-link').on('click', function() {
        $('.nav-link').removeClass('bg-indigo-700');
        $(this).addClass('bg-indigo-700');
      });
      
      // Set initial active link
      $('.nav-link[data-page="register"]').addClass('bg-indigo-700');
    });
  </script>
</body>
</html>